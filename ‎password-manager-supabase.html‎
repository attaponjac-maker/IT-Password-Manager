<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IT Password Manager - Multi-User</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bai+Jamjuree:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Supabase JS Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- CryptoJS for AES Encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg: #f8fafc;
            --card: #ffffff;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
        }

        body {
            font-family: 'Bai Jamjuree', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Auth Screens */
        .auth-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .auth-card {
            background: var(--card);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 450px;
        }

        .auth-card h1 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--primary);
        }

        .auth-card p {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 30px;
        }

        .auth-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .auth-tab {
            flex: 1;
            padding: 10px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .auth-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* Buttons */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-family: inherit;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        /* Forms */
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 15px;
            font-family: inherit;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text);
        }

        /* Alerts */
        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-danger {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* Utilities */
        .hidden {
            display: none !important;
        }

        .text-center {
            text-align: center;
        }

        .mt-20 {
            margin-top: 20px;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid white;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Team Selection */
        .team-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .team-card {
            background: var(--bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--border);
            cursor: pointer;
            transition: all 0.3s;
        }

        .team-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.1);
        }

        .team-card h3 {
            margin-bottom: 8px;
            color: var(--primary);
        }

        .team-card .role-badge {
            display: inline-block;
            padding: 4px 10px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .role-badge.admin { background: #ef4444; }
        .role-badge.user { background: #3b82f6; }
        .role-badge.viewer { background: #64748b; }

        /* Header */
        .header {
            background: var(--card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .header h1 {
            color: var(--primary);
            font-size: 24px;
        }

        .header-info {
            font-size: 13px;
            color: var(--text-light);
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: var(--card);
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border: 2px solid var(--border);
            transition: all 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: var(--text-light);
        }

        /* Config Warning */
        .config-warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }

        .config-warning h2 {
            color: #92400e;
            margin-bottom: 10px;
        }

        .config-warning code {
            background: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Configuration Warning (‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÄ‡∏°‡∏∑‡πà‡∏≠ Config ‡πÄ‡∏™‡∏£‡πá‡∏à) -->
    <div id="configWarning" class="container">
        <div class="config-warning">
            <h2>‚öôÔ∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Supabase</h2>
            <p style="margin-bottom: 15px;">
                ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Code ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡πÉ‡∏ô HTML file ‡πÇ‡∏î‡∏¢‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
            </p>
            <ol style="margin-left: 20px; line-height: 2;">
                <li>‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏î‡πâ‡∏ß‡∏¢ Text Editor</li>
                <li>‡∏´‡∏≤‡∏™‡πà‡∏ß‡∏ô <code>SUPABASE CONFIG</code> (‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ó‡∏µ‡πà ~240)</li>
                <li>‡πÅ‡∏Å‡πâ <code>SUPABASE_URL</code> ‡πÅ‡∏•‡∏∞ <code>SUPABASE_ANON_KEY</code></li>
                <li>Save ‡πÅ‡∏•‡πâ‡∏ß Refresh ‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</li>
            </ol>
            <p style="margin-top: 15px; font-size: 13px; color: #92400e;">
                üìñ ‡∏≠‡πà‡∏≤‡∏ô <strong>SUPABASE_SETUP_GUIDE.md</strong> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏ß‡∏¥‡∏ò‡∏µ Setup Supabase
            </p>
        </div>
    </div>

    <!-- Login/Register Screen -->
    <div id="authScreen" class="auth-screen hidden">
        <div class="auth-card">
            <h1>üîê IT Password Manager</h1>
            <p>Multi-User Cloud Edition</p>
            
            <div id="authAlert"></div>
            
            <!-- Tabs -->
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="switchAuthTab('login')">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</div>
                <div class="auth-tab" onclick="switchAuthTab('register')">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="hidden">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com" required>
                
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="hidden">
                <label>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</label>
                <input type="text" id="registerName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏°‡∏ä‡∏≤‡∏¢ ‡πÉ‡∏à‡∏î‡∏µ" required>

                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="your@email.com" required>
                
                <label>Password</label>
                <input type="password" id="registerPassword" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô (8+ ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)" required minlength="8">
                
                <label>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô Password</label>
                <input type="password" id="registerPasswordConfirm" placeholder="‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô" required>
                
                <button type="submit" class="btn btn-success" style="width: 100%;">
                    ‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å
                </button>
            </form>
        </div>
    </div>

    <!-- Team Selection Screen -->
    <div id="teamScreen" class="auth-screen hidden">
        <div class="auth-card" style="max-width: 700px;">
            <h1>üè¢ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Workspace</h1>
            <p>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Team/Workspace ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</p>
            
            <div id="teamGrid" class="team-grid"></div>

            <button class="btn btn-success mt-20" onclick="showCreateTeamForm()" style="width: 100%;">
                ‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Team ‡πÉ‡∏´‡∏°‡πà
            </button>

            <button class="btn btn-secondary mt-20" onclick="logout()" style="width: 100%;">
                üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
            </button>
        </div>
    </div>

    <!-- Create Team Modal (Simple version) -->
    <div id="createTeamModal" class="auth-screen hidden">
        <div class="auth-card">
            <h2>‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á Team ‡πÉ‡∏´‡∏°‡πà</h2>
            
            <form id="createTeamForm">
                <label>‡∏ä‡∏∑‡πà‡∏≠ Team</label>
                <input type="text" id="teamName" placeholder="‡πÄ‡∏ä‡πà‡∏ô Rubber Business IT" required>
                
                <label>‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ (Optional)</label>
                <textarea id="teamDesc" rows="3" placeholder="IT Department - Southern Thailand"></textarea>
                
                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-success" style="flex: 1;">‡∏™‡∏£‡πâ‡∏≤‡∏á</button>
                    <button type="button" class="btn btn-secondary" onclick="hideCreateTeamForm()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App (Will be implemented after user selects team) -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <div class="header">
                <div>
                    <h1>üîê IT Password Manager</h1>
                    <div class="header-info" id="headerInfo">
                        Loading...
                    </div>
                </div>
                <div class="header-actions">
                    <button class="btn btn-primary" onclick="showTeamSelector()">
                        üè¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô Team
                    </button>
                    <button class="btn btn-secondary" onclick="logout()">
                        üö™ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
                    </button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üîê</div>
                    <div class="stat-value" id="statTotal">0</div>
                    <div class="stat-label">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üè¢</div>
                    <div class="stat-value" id="statBranches">0</div>
                    <div class="stat-label">‡∏™‡∏≤‡∏Ç‡∏≤</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö†Ô∏è</div>
                    <div class="stat-value" id="statExpiring">0</div>
                    <div class="stat-label">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="statMembers">0</div>
                    <div class="stat-label">‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</div>
                </div>
            </div>

            <div class="text-center mt-20">
                <p style="color: var(--text-light);">
                    üöß Main application UI coming next...<br>
                    Connected to Supabase successfully!
                </p>
            </div>
        </div>
    </div>

    <script>
        // ===================================
        // SUPABASE CONFIG - ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ!
        // ===================================
        
        const SUPABASE_URL = 'https://celfxsflqfbxxhcndaio.supabase.co'; // ‡πÄ‡∏ä‡πà‡∏ô https://xxxxx.supabase.co
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNlbGZ4c2ZscWZieHhoY25kYWlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg5MTczNjUsImV4cCI6MjA4NDQ5MzM2NX0.tFiJcElcVyg1_lPomt03enLnLwH2ZKQZU0iObO4jRm4'; // eyJhbGciOiJIUzI1...
        
        // ===================================
        // Initialize Supabase Client
        // ===================================
        
        let supabase;
        let currentUser = null;
        let currentTeam = null;
        let userRole = null;

        // Check if configured
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            console.warn('‚ö†Ô∏è Supabase not configured yet!');
            document.getElementById('configWarning').classList.remove('hidden');
        } else {
            // Initialize
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            document.getElementById('configWarning').classList.add('hidden');
            initApp();
        }

        // ===================================
        // App Initialization
        // ===================================
        
        async function initApp() {
            console.log('üöÄ Initializing app...');
            
            // Check current session
            const { data: { session } } = await supabase.auth.getSession();
            
            if (session) {
                currentUser = session.user;
                await loadUserTeams();
            } else {
                showAuthScreen();
            }

            // Listen to auth changes
            supabase.auth.onAuthStateChange((event, session) => {
                if (event === 'SIGNED_IN') {
                    currentUser = session.user;
                    loadUserTeams();
                } else if (event === 'SIGNED_OUT') {
                    currentUser = null;
                    currentTeam = null;
                    showAuthScreen();
                }
            });

            // Setup forms
            setupForms();
        }

        // ===================================
        // Authentication Functions
        // ===================================
        
        function showAuthScreen() {
            hideAllScreens();
            document.getElementById('authScreen').classList.remove('hidden');
            switchAuthTab('login');
        }

        function switchAuthTab(tab) {
            const tabs = document.querySelectorAll('.auth-tab');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.add('hidden');

            if (tab === 'login') {
                document.getElementById('loginForm').classList.remove('hidden');
            } else {
                document.getElementById('registerForm').classList.remove('hidden');
            }
        }

        function setupForms() {
            // Login Form
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                showAuthAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...', 'info');

                const { error } = await supabase.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    showAuthAlert(error.message, 'danger');
                } else {
                    showAuthAlert('‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
                }
            });

            // Register Form
            document.getElementById('registerForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerPasswordConfirm').value;

                if (password !== confirmPassword) {
                    showAuthAlert('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô!', 'danger');
                    return;
                }

                showAuthAlert('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å...', 'info');

                const { error } = await supabase.auth.signUp({
                    email,
                    password,
                    options: {
                        data: {
                            full_name: name
                        }
                    }
                });

                if (error) {
                    showAuthAlert(error.message, 'danger');
                } else {
                    showAuthAlert('‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'success');
                }
            });

            // Create Team Form
            document.getElementById('createTeamForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await createTeam();
            });
        }

        function showAuthAlert(message, type) {
            const alert = document.getElementById('authAlert');
            alert.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alert.innerHTML = '', 5000);
        }

        // ===================================
        // Team Management
        // ===================================
        
        async function loadUserTeams() {
            const { data: memberships, error } = await supabase
                .from('team_members')
                .select(`
                    role,
                    teams (
                        id,
                        name,
                        description
                    )
                `)
                .eq('user_id', currentUser.id);

            if (error) {
                console.error('Error loading teams:', error);
                return;
            }

            if (memberships.length === 0) {
                // No teams, show team creation
                showTeamScreen([]);
            } else if (memberships.length === 1) {
                // Auto-select if only one team
                currentTeam = memberships[0].teams;
                userRole = memberships[0].role;
                showMainApp();
            } else {
                // Multiple teams, let user choose
                showTeamScreen(memberships);
            }
        }

        function showTeamScreen(memberships) {
            hideAllScreens();
            document.getElementById('teamScreen').classList.remove('hidden');

            const grid = document.getElementById('teamGrid');
            
            if (memberships.length === 0) {
                grid.innerHTML = '<p class="text-center" style="color: var(--text-light);">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ Team<br>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á Team ‡πÉ‡∏´‡∏°‡πà ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÄ‡∏ä‡∏¥‡∏ç‡πÄ‡∏Ç‡πâ‡∏≤ Team</p>';
                return;
            }

            grid.innerHTML = memberships.map(m => `
                <div class="team-card" onclick="selectTeam('${m.teams.id}', '${m.role}')">
                    <h3>üè¢ ${m.teams.name}</h3>
                    <p style="font-size: 13px; color: var(--text-light); margin-bottom: 10px;">
                        ${m.teams.description || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢'}
                    </p>
                    <span class="role-badge ${m.role}">${m.role}</span>
                </div>
            `).join('');
        }

        async function selectTeam(teamId, role) {
            const { data, error } = await supabase
                .from('teams')
                .select('*')
                .eq('id', teamId)
                .single();

            if (!error) {
                currentTeam = data;
                userRole = role;
                showMainApp();
            }
        }

        function showCreateTeamForm() {
            hideAllScreens();
            document.getElementById('createTeamModal').classList.remove('hidden');
        }

        function hideCreateTeamForm() {
            document.getElementById('createTeamModal').classList.add('hidden');
            showTeamScreen([]);
            loadUserTeams();
        }

        async function createTeam() {
            const name = document.getElementById('teamName').value;
            const description = document.getElementById('teamDesc').value;

            // Create team
            const { data: team, error: teamError } = await supabase
                .from('teams')
                .insert({
                    name,
                    description,
                    created_by: currentUser.id
                })
                .select()
                .single();

            if (teamError) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + teamError.message);
                return;
            }

            // Add creator as admin
            const { error: memberError } = await supabase
                .from('team_members')
                .insert({
                    team_id: team.id,
                    user_id: currentUser.id,
                    role: 'admin'
                });

            if (memberError) {
                alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + memberError.message);
                return;
            }

            alert('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á Team ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
            hideCreateTeamForm();
        }

        function showTeamSelector() {
            loadUserTeams();
        }

        // ===================================
        // Main App
        // ===================================
        
        async function showMainApp() {
            hideAllScreens();
            document.getElementById('mainApp').classList.remove('hidden');

            // Update header
            const headerInfo = document.getElementById('headerInfo');
            headerInfo.innerHTML = `
                üè¢ <strong>${currentTeam.name}</strong> | 
                üë§ ${currentUser.email} | 
                üìã <span class="role-badge ${userRole}">${userRole}</span>
            `;

            // Load stats
            await loadStats();
        }

        async function loadStats() {
            // Count credentials
            const { count: credCount } = await supabase
                .from('credentials')
                .select('*', { count: 'exact', head: true })
                .eq('team_id', currentTeam.id);

            // Count branches
            const { count: branchCount } = await supabase
                .from('branches')
                .select('*', { count: 'exact', head: true })
                .eq('team_id', currentTeam.id);

            // Count members
            const { count: memberCount } = await supabase
                .from('team_members')
                .select('*', { count: 'exact', head: true })
                .eq('team_id', currentTeam.id);

            // Count expiring (next 30 days)
            const thirtyDaysFromNow = new Date();
            thirtyDaysFromNow.setDate(thirtyDaysFromNow.getDate() + 30);
            
            const { count: expiringCount } = await supabase
                .from('credentials')
                .select('*', { count: 'exact', head: true })
                .eq('team_id', currentTeam.id)
                .not('expiry_date', 'is', null)
                .gte('expiry_date', new Date().toISOString().split('T')[0])
                .lte('expiry_date', thirtyDaysFromNow.toISOString().split('T')[0]);

            // Update UI
            document.getElementById('statTotal').textContent = credCount || 0;
            document.getElementById('statBranches').textContent = branchCount || 0;
            document.getElementById('statExpiring').textContent = expiringCount || 0;
            document.getElementById('statMembers').textContent = memberCount || 0;
        }

        // ===================================
        // Logout
        // ===================================
        
        async function logout() {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö?')) {
                await supabase.auth.signOut();
            }
        }

        // ===================================
        // Utilities
        // ===================================
        
        function hideAllScreens() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('teamScreen').classList.add('hidden');
            document.getElementById('createTeamModal').classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    </script>
</body>
</html>
